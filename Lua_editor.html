<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GameGuardian Lua Editor V16 (Multi-line Search & Share)</title>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --sidebar-bg: #252526;
            --header-bg: #2d2d2d;
            --text-color: #cccccc;
            --highlight: #0e639c;
            --border: #3e3e42;
            --btn-bg: #3c3c3c;
            --btn-hover: #505050;
            --func-color: #dcdcaa;
            --const-color: #4fc1ff;
            --keyword-color: #c586c0;
            --var-color: #9cdcfe;
            --comment-color: #6a9955;
        }
        * { box-sizing: border-box; outline: none; }
        body {
            margin: 0; padding: 0;
            width: 100vw; height: 100vh;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }

        #toolbar {
            background-color: var(--header-bg);
            border-bottom: 1px solid var(--border);
            padding: 4px 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
            z-index: 100;
        }
        .btn-group {
            display: flex; gap: 1px; background: #444; padding: 2px; border-radius: 4px;
        }
        button {
            background-color: var(--btn-bg); color: #eee; border: 1px solid transparent;
            padding: 5px 10px; cursor: pointer; font-size: 12px; border-radius: 2px;
            transition: all 0.1s; user-select: none;
        }
        button:hover { background-color: var(--btn-hover); }
        button:active { background-color: var(--highlight); }
        
        .search-container {
            display: flex; align-items: center; background: #333; padding: 2px 5px; border-radius: 4px; border: 1px solid #555;
        }
        #search-input {
            background: transparent; border: none; color: white; width: 140px; font-size: 12px; margin-right: 5px;
        }
        .search-badge {
            font-size: 10px; color: #aaa; margin-right: 5px; min-width: 40px; text-align: center;
        }
        .search-opt {
            font-size: 10px; color: #ccc; display: flex; align-items: center; gap: 3px; margin-right: 5px; cursor: pointer; user-select: none;
        }
        
        #filename {
            background: #333; border: 1px solid #555; color: #eee; padding: 4px; font-size: 12px; width: 100px; border-radius: 3px;
        }

        #main-area { display: flex; flex: 1; height: calc(100vh - 80px); position: relative; }
        #editor-container { flex: 1; height: 100%; overflow: hidden; }

        #sidebar {
            width: 260px; background-color: var(--sidebar-bg); border-left: 1px solid var(--border);
            display: flex; flex-direction: column; z-index: 90;
        }
        #sidebar-header {
            padding: 5px; background: #222; font-size: 11px;
            border-bottom: 1px solid var(--border); color: #aaa; text-align: center;
        }
        #candidate-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        
        .candidate-item {
            padding: 4px 8px; cursor: pointer; border-bottom: 1px solid #333;
            display: flex; flex-direction: column; justify-content: center;
        }
        .candidate-item:hover { background-color: #2a2d2e; }
        
        .cand-top { display: flex; justify-content: space-between; align-items: center; }
        .cand-label { font-weight: bold; font-size: 12px; }
        .cand-meaning { font-size: 10px; color: var(--comment-color); margin-left: 8px; font-style: italic; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px; }
        .cand-type { font-size: 9px; padding: 1px 3px; border-radius: 3px; background: #333; min-width: 25px; text-align: center; }
        .cand-desc { font-size: 10px; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; }

        #statusbar {
            height: 22px; background: #007acc; color: white; font-size: 11px;
            display: flex; align-items: center; padding: 0 10px; justify-content: space-between;
            white-space: nowrap; overflow: hidden;
        }

        #toast {
            visibility: hidden; min-width: 200px; background-color: #333; color: #fff;
            text-align: center; border-radius: 4px; padding: 8px; position: fixed;
            z-index: 2000; left: 50%; bottom: 40px; transform: translateX(-50%);
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); font-size: 12px; border: 1px solid #555;
            opacity: 0; transition: opacity 0.3s, bottom 0.3s;
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }

        .search-line-highlight { background: rgba(255, 0, 0, 0.4) !important; border-left: 3px solid #ff0000; }
        .search-match-text { background-color: #ffffff !important; color: #000000 !important; font-weight: bold !important; border-radius: 2px; }

        /* モーダル */
        #modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 3000; align-items: center; justify-content: center;
        }
        .modal-box {
            background: #252526; padding: 15px; border-radius: 5px; border: 1px solid #444;
            width: 320px; color: #eee;
        }
        .modal-box input { width: 100%; margin-bottom: 10px; padding: 6px; background: #333; border: 1px solid #555; color: white; }
        .modal-btns { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }

        @media (max-width: 768px) {
            #sidebar { display: none; position: absolute; right: 0; top: 0; bottom: 0; width: 220px; box-shadow: -5px 0 15px rgba(0,0,0,0.5); }
            #sidebar.open { display: flex; }
            #search-input { width: 80px; }
            #filename { width: 70px; }
        }
    </style>
</head>
<body>

<div id="toolbar">
    <div class="btn-group">
        <button onclick="execCmd('undo')" title="元に戻す">↩</button>
        <button onclick="execCmd('redo')" title="やり直し">↪</button>
    </div>
    
    <div class="btn-group">
        <button onclick="formatCode()" title="整形 (end後空行追加)">整形</button>
        <button onclick="autoComment()" title="解説を追加">解説</button>
        <button onclick="showReplaceModal()" title="変数を指定文字列に一括置換">変数置換</button>
    </div>

    <div class="search-container">
        <input type="text" id="search-input" placeholder="リアルタイム検索..." oninput="doSearch()" onkeydown="if(event.key==='Enter') searchNext(true)">
        <label class="search-opt"><input type="checkbox" id="search-fuzzy" checked onchange="doSearch()">部分一致</label>
        <div class="search-badge" id="search-count">0/0</div>
        <div class="btn-group">
            <button onclick="searchNext(false)" title="前へ">▲</button>
            <button onclick="searchNext(true)" title="次へ">▼</button>
        </div>
    </div>

    <div class="btn-group" style="margin-left:auto;">
        <button onclick="toggleSidebar()">候補</button>
        <button onclick="document.getElementById('fileInput').click()">開く</button>
        <input type="text" id="filename" value="script.lua" placeholder="ファイル名">
        <button onclick="saveFile()">保存</button>
        <button onclick="shareScript()" style="background-color:#007acc;" title="共有 (ChromeOS/Android対応)">共有</button>
        <input type="file" id="fileInput" accept=".txt,.lua" style="display:none" onchange="importFile(this)">
    </div>
</div>

<div id="main-area">
    <div id="editor-container"></div>
    <div id="sidebar">
        <div id="sidebar-header">候補一覧 (コメントも表示)</div>
        <ul id="candidate-list"></ul>
    </div>
</div>

<div id="statusbar">
    <span id="hint-msg">GameGuardian Lua Editor V16</span>
    <span id="cursor-pos">Ln 1, Col 1</span>
</div>

<div id="toast">Message</div>

<!-- 変数置換モーダル -->
<div id="modal-overlay">
    <div class="modal-box">
        <h3>変数一括置換</h3>
        <p style="font-size:11px; color:#aaa;">変数を指定した文字列に置き換えます(全置換)。</p>
        <label>対象の変数名 (難読化文字列など):</label>
        <input type="text" id="replace-target" placeholder="例: _a">
        <label>置き換え後の文字列:</label>
        <input type="text" id="replace-with" placeholder="例: myValue">
        <div class="modal-btns">
            <button onclick="closeModal()" style="background:#555;">キャンセル</button>
            <button onclick="doReplaceVar()" style="background:#0e639c;">全て置換</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.38.0/min/vs/loader.min.js"></script>

<script>
    const apiData = [
        {l:'gg.alert', d:'警告ダイアログ', t:'func', i:'gg.alert("${1:msg}")'},
        {l:'gg.toast', d:'通知を表示', t:'func', i:'gg.toast("${1:msg}")'},
        {l:'gg.searchNumber', d:'数値検索', t:'func', i:'gg.searchNumber("${1:100}", ${2:gg.TYPE_DWORD})'},
        {l:'gg.clearResults', d:'結果消去', t:'func', i:'gg.clearResults()'},
        {l:'gg.getResults', d:'結果取得', t:'func', i:'gg.getResults(${1:100})'},
        {l:'gg.editAll', d:'全編集', t:'func', i:'gg.editAll("${1:val}", ${2:gg.TYPE_DWORD})'},
        {l:'gg.setValues', d:'値書き込み', t:'func', i:'gg.setValues(${1:t})'},
        {l:'gg.getValues', d:'値読み込み', t:'func', i:'gg.getValues(${1:t})'},
        {l:'gg.process', d:'プロセス選択', t:'func', i:'gg.process(${1:proc})'},
        {l:'gg.sleep', d:'待機 (ms)', t:'func', i:'gg.sleep(${1:1000})'},
        {l:'gg.isVisible', d:'表示確認', t:'func', i:'gg.isVisible()'},
        {l:'gg.setVisible', d:'表示切替', t:'func', i:'gg.setVisible(${1:true})'},
        {l:'gg.prompt', d:'入力', t:'func', i:'gg.prompt({${1:"Msg"}}, {${2}}, {${3:"number"}})'},
        {l:'gg.choice', d:'選択', t:'func', i:'gg.choice({${1:"A","B"}}, ${2:nil}, ${3:"Title"})'},
        {l:'gg.multiChoice', d:'複数選択', t:'func', i:'gg.multiChoice({${1:"A","B"}}, {${2}}, ${3:"Title"})'},
        {l:'gg.bytes', d:'Bytes変換', t:'func', i:'gg.bytes("${1:str}", "UTF-8")'},
        {l:'gg.makeRequest', d:'HTTP', t:'func', i:'gg.makeRequest("${1:url}")'},
        {l:'gg.copyText', d:'コピー', t:'func', i:'gg.copyText("${1:text}")'},
        {l:'gg.saveVariable', d:'変数保存', t:'func', i:'gg.saveVariable("${1:k}", ${2:v})'},
        {l:'gg.loadVariable', d:'変数読込', t:'func', i:'gg.loadVariable("${1:k}")'},
        {l:'gg.addListItems', d:'リスト追加', t:'func', i:'gg.addListItems(${1:t})'},
        {l:'gg.removeListItems', d:'リスト削除', t:'func', i:'gg.removeListItems(${1:t})'},
        
        {l:'gg.TYPE_DWORD', t:'const', d:'4byte'}, {l:'gg.TYPE_FLOAT', t:'const', d:'Float'}, 
        {l:'gg.TYPE_DOUBLE', t:'const', d:'Double'}, {l:'gg.TYPE_QWORD', t:'const', d:'8byte'}, 
        {l:'gg.TYPE_WORD', t:'const', d:'2byte'}, {l:'gg.TYPE_BYTE', t:'const', d:'1byte'},
        {l:'gg.TYPE_AUTO', t:'const', d:'Auto'}, {l:'gg.REGION_ANONYMOUS', t:'const', d:'Xa'}, 
        
        {l:'print', t:'func', i:'print(${1})', d:'ログ'}, {l:'tonumber', t:'func', i:'tonumber(${1})', d:'数値化'},
        {l:'tostring', t:'func', i:'tostring(${1})', d:'文字化'}, {l:'type', t:'func', i:'type(${1})', d:'型'},
        {l:'pairs', t:'func', i:'pairs(${1:t})', d:'Pairs'}, {l:'ipairs', t:'func', i:'ipairs(${1:t})', d:'iPairs'},
        {l:'string.format', t:'func', i:'string.format("${1:%s}", ${2:v})', d:'Format'}, 
        {l:'string.find', t:'func', i:'string.find(${1:s}, "${2:pat}")', d:'Find'},
        {l:'table.insert', t:'func', i:'table.insert(${1:t}, ${2:v})', d:'Insert'}, 
        {l:'table.remove', t:'func', i:'table.remove(${1:t}, ${2:pos})', d:'Remove'},
        {l:'os.clock', t:'func', i:'os.clock()', d:'Clock'}, {l:'os.time', t:'func', i:'os.time()', d:'Time'}, 
        {l:'os.exit', t:'func', i:'os.exit()', d:'Exit'}, {l:'io.open', t:'func', i:'io.open("${1:file}", "${2:w}")', d:'File'},
        
        {l:'local', t:'key', i:'local ', d:'宣言'}, {l:'function', t:'key', i:'function ${1:name}(${2})\n\t${3}\nend', d:'関数'},
        {l:'return', t:'key', i:'return ', d:'戻り値'}, {l:'if', t:'key', i:'if ${1:cond} then\n\t${2}\nend', d:'もし'},
        {l:'while', t:'key', i:'while ${1:cond} do\n\t${2}\nend', d:'ループ'}, {l:'for', t:'key', i:'for i = ${1:1}, ${2:10} do\n\t${3}\nend', d:'ループ'},
        {l:'else', t:'key', i:'else', d:'他'}, {l:'elseif', t:'key', i:'elseif', d:'他もし'}, {l:'then', t:'key', i:'then', d:'なら'},
        {l:'end', t:'key', i:'end', d:'終'}, {l:'repeat', t:'key', i:'repeat', d:'反復'}, {l:'until', t:'key', i:'until', d:'まで'},
    ];

    let editor;
    let userDefinedVars = []; 
    let isInserting = false;
    let searchMatches = [];
    let currentMatchIdx = -1;
    let currentDecorations = []; 

    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.38.0/min/vs' }});

    require(['vs/editor/editor.main'], function() {
        monaco.languages.registerCompletionItemProvider('lua', {
            provideCompletionItems: function(model, position) {
                const wordInfo = model.getWordUntilPosition(position);
                const range = {
                    startLineNumber: position.lineNumber, endLineNumber: position.lineNumber,
                    startColumn: wordInfo.startColumn, endColumn: wordInfo.endColumn
                };
                
                const suggestions = [
                    ...apiData.map(item => ({
                        label: item.l, kind: getKind(item.t), documentation: item.d,
                        insertText: item.i || item.l, insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                        range: range, detail: item.d
                    })),
                    ...userDefinedVars.map(v => ({
                        label: v.l, kind: v.t === 'func_user' ? monaco.languages.CompletionItemKind.Function : monaco.languages.CompletionItemKind.Variable,
                        insertText: v.l, range: range, detail: v.d ? v.d : 'User Defined'
                    }))
                ];
                return { suggestions: suggestions };
            }
        });

        editor = monaco.editor.create(document.getElementById('editor-container'), {
            value: '-- GameGuardian Script V16\n\nlocal myVar = 100\n\nfunction test()\n    if myVar > 50 then\n        print("OK")\n    end\nend\n',
            language: 'lua',
            theme: 'vs-dark',
            automaticLayout: true,
            fontSize: 14,
            minimap: { enabled: true },
            wordWrap: 'off',
            scrollBeyondLastColumn: 5,
            suggest: { filterGraceful: true, snippetsPreventQuickSuggestions: false }
        });

        editor.onDidChangeModelContent(() => { parseUserVars(); updateSidebar(); doSearch(); }); // 内容変更時も検索更新
        editor.onDidChangeCursorPosition((e) => {
            updateSidebarPosition(e.position);
            document.getElementById('cursor-pos').innerText = `Ln ${e.position.lineNumber}, Col ${e.position.column}`;
        });
        
        editor.onMouseUp(() => checkSelectionCopy());
        editor.onKeyUp(() => checkSelectionCopy());

        parseUserVars();
        updateSidebar();
        startHintCycle();
    });

    // --- 変数一括置換機能 (全置換・単語単位) ---
    function showReplaceModal() {
        const sel = editor.getSelection();
        const txt = editor.getModel().getValueInRange(sel);
        if(txt) document.getElementById('replace-target').value = txt;
        document.getElementById('modal-overlay').style.display = 'flex';
    }
    
    function closeModal() {
        document.getElementById('modal-overlay').style.display = 'none';
    }

    function doReplaceVar() {
        const target = document.getElementById('replace-target').value;
        const replaceWith = document.getElementById('replace-with').value;
        
        if (!target) { showToast("対象の変数名を入力してください"); return; }

        const model = editor.getModel();
        // findMatches(searchString, searchOnlyEditableRange, isRegex, matchCase, wordSeparators, captureMatches)
        // ここでは matchWord (単語単位) で検索したい。MonacoのfindMatches引数は:
        // (searchString, matchCase, isRegex, matchWord, wordSeparators, captureMatches)
        const matches = model.findMatches(target, false, false, true, null, true); 
        
        if (matches.length === 0) {
            showToast("対象の変数が見つかりません");
            return;
        }

        const edits = matches.map(match => ({
            range: match.range,
            text: replaceWith
        }));

        editor.executeEdits('replaceVar', edits);
        closeModal();
        showToast(`${matches.length}箇所の変数を置換しました`);
    }

    function checkSelectionCopy() {
        if(isInserting) { isInserting = false; return; }
        const sel = editor.getSelection();
        if(!sel || sel.isEmpty()) return;
        const txt = editor.getModel().getValueInRange(sel);
        if(txt) navigator.clipboard.writeText(txt).then(() => showToast("コピーしました")).catch(()=>{});
    }

    function insertCode(item) {
        if (!editor) return;
        isInserting = true;
        editor.focus();
        const pos = editor.getPosition();
        const model = editor.getModel();
        const wordInfo = model.getWordUntilPosition(pos);
        const lineContent = model.getLineContent(pos.lineNumber);
        const textBeforeCursor = lineContent.substring(0, pos.column - 1);
        
        let insertText = item.i || item.l;
        const rawLabel = item.l; 

        if (rawLabel.includes('.')) {
            const parts = rawLabel.split('.');
            const prefix = parts[0] + '.'; 
            const checkStr = textBeforeCursor.trim();
            if (new RegExp(prefix.replace('.', '\\.') + '[a-zA-Z0-9_]*$').test(checkStr)) {
                if (insertText.startsWith(prefix)) {
                    insertText = insertText.substring(prefix.length);
                }
            }
        }

        const range = new monaco.Range(pos.lineNumber, wordInfo.startColumn, pos.lineNumber, wordInfo.endColumn);
        editor.setSelection(range);
        const contrib = editor.getContribution('snippetController2');
        if (contrib) contrib.insert(insertText);
        else editor.trigger('keyboard', 'type', { text: insertText });
        setTimeout(() => { isInserting = false; }, 100);
    }

    // --- 整形機能 ---
    function formatCode() {
        if (!editor) return;
        const model = editor.getModel();
        const rawCode = model.getValue();
        
        const stringStore = [];
        const maskedCode = rawCode.replace(/(["'])(?:(?=(\\?))\2.)*?\1/g, function(match) {
            stringStore.push(match);
            return `__STR_${stringStore.length - 1}__`;
        });

        let code = maskedCode;
        code = code.replace(/(\b(then|do|repeat)\b)(?!\s*(--.*)?$)/g, "$1\n");
        code = code.replace(/(?<!^)(?<!\n)\s*(\b(end|until)\b)/g, "\n$1");
        code = code.replace(/;\s*/g, ";\n");

        let lines = code.split(/\r?\n/);
        let formattedLines = [];
        let depth = 0;
        const indentStr = "    ";
        const reElse = /^\s*(else|elseif)\b/;
        const reBlockEnd = /^\s*(end|until|\}|\))/;

        for (let i = 0; i < lines.length; i++) {
            let line = lines[i].trim();
            if (!line) continue;

            const cleanLine = line.split('--')[0].trim();
            let printDepth = depth;
            
            if (reBlockEnd.test(cleanLine)) {
                depth--;
                printDepth = depth;
            } else if (reElse.test(cleanLine)) {
                printDepth = depth - 1;
            }

            if (printDepth < 0) printDepth = 0;
            if (depth < 0) depth = 0;

            formattedLines.push(indentStr.repeat(printDepth) + line);

            const opens = (cleanLine.match(/(\b(function|then|do|repeat)\b|\{|\()/g) || []).length;
            const closes = (cleanLine.match(/(\b(end|until)\b|\}|\))/g) || []).length;
            let delta = opens - closes;
            if (reBlockEnd.test(cleanLine)) delta += 1;
            
            // end後に空行追加
            if (/\b(end|until)\b(\s*--.*)?$/.test(cleanLine)) {
                formattedLines.push("");
                formattedLines.push(""); 
            }

            depth += delta;
        }

        let finalCode = formattedLines.join("\n");
        finalCode = finalCode.replace(/\n{4,}/g, "\n\n\n");
        finalCode = finalCode.replace(/__STR_(\d+)__/g, (m, id) => stringStore[id]);

        const fullRange = model.getFullModelRange();
        editor.executeEdits('formatCode', [{ range: fullRange, text: finalCode, forceMoveMarkers: true }]);
        showToast("整形完了");
    }

    // --- V16 強化版検索機能 (改行跨ぎ & インクリメンタル) ---
    function doSearch() {
        const query = document.getElementById('search-input').value;
        const model = editor.getModel();
        
        if (!query) {
            document.getElementById('search-count').innerText = "0/0";
            currentDecorations = editor.deltaDecorations(currentDecorations, []);
            searchMatches = [];
            return;
        }

        const isFuzzy = document.getElementById('search-fuzzy').checked;
        let regexQuery;
        
        if (isFuzzy) {
            // 入力された文字列のスペースを「改行を含むあらゆる空白」に置換し、
            // 文字列全体を正規表現として構築する
            // 例: "local gg" -> "local[\s\n]*gg"
            // まず特殊文字をエスケープ
            const parts = query.trim().split(/\s+/);
            const escapedParts = parts.map(p => p.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
            // 間に改行込みの空白マッチを挟む
            regexQuery = escapedParts.join('[\\s\\n]*'); 
        } else {
            regexQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        try {
            // findMatches: (searchString, matchCase, isRegex, matchWord, wordSeparators, captureMatches)
            searchMatches = model.findMatches(regexQuery, false, true, false, null, true);
        } catch(e) { searchMatches = []; }

        const countEl = document.getElementById('search-count');
        countEl.innerText = searchMatches.length > 0 ? `1/${searchMatches.length}` : "0/0";

        const decorations = searchMatches.map(match => ({
            range: match.range,
            options: { className: 'search-match-text', isWholeLine: false, overviewRuler: { color: 'red', position: 1 } }
        }));
        
        const lineDecorations = searchMatches.map(match => ({
            range: match.range,
            options: { isWholeLine: true, className: 'search-line-highlight' }
        }));

        currentDecorations = editor.deltaDecorations(currentDecorations, [...decorations, ...lineDecorations]);
    }

    function searchNext(isNext) {
        if (searchMatches.length === 0) {
            doSearch();
            if (searchMatches.length === 0) return;
        }
        if (isNext) currentMatchIdx = (currentMatchIdx + 1) % searchMatches.length;
        else currentMatchIdx = (currentMatchIdx - 1 + searchMatches.length) % searchMatches.length;

        document.getElementById('search-count').innerText = `${currentMatchIdx + 1}/${searchMatches.length}`;
        editor.revealRangeInCenter(searchMatches[currentMatchIdx].range);
    }

    function execCmd(cmd) {
        editor.focus();
        if(cmd==='undo') editor.trigger('k','undo');
        else if(cmd==='redo') editor.trigger('k','redo');
        else editor.trigger('s', cmd);
    }

    function autoComment() {
        const m = editor.getModel();
        const edits = [];
        const dict = {}; apiData.forEach(i=>dict[i.l]=i.d);
        for(let i=1; i<=m.getLineCount(); i++){
            const l = m.getLineContent(i);
            if(l.includes('--')) continue;
            for(let k in dict){
                if(l.includes(k+'(') || l.includes(k+' ')){
                    edits.push({ range: new monaco.Range(i, l.length+1, i, l.length+1), text: ` -- ${dict[k]}` });
                    break;
                }
            }
        }
        if(edits.length) { editor.executeEdits('autoComment', edits); showToast("解説を追加しました"); }
    }

    function startHintCycle() {
        const hints = [
            "ヒント: '変数置換'はすべての変数を一括で書き換えます",
            "ヒント: 共有ボタンでChromeOSやAndroid間でファイルを共有可能",
            "ヒント: 検索機能は改行をまたいだコードもヒットします",
            "ヒント: Ctrl+Z で元に戻すことができます"
        ];
        let idx = 0;
        const el = document.getElementById('hint-msg');
        setInterval(() => { idx = (idx + 1) % hints.length; el.innerText = hints[idx]; }, 4000);
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.className = "show";
        setTimeout(() => t.className = "", 2000);
    }

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
    
    function parseUserVars() {
        if(!editor) return;
        const model = editor.getModel();
        const lineCount = model.getLineCount();
        const vars = new Map();

        for (let i = 1; i <= lineCount; i++) {
            const line = model.getLineContent(i);
            let comment = "";
            const commentMatch = line.match(/--\s*(.*)$/);
            if (commentMatch) comment = commentMatch[1].trim();
            const codePart = line.split('--')[0];

            const localMatch = codePart.match(/local\s+([a-zA-Z_]\w*)/);
            if (localMatch) {
                vars.set(localMatch[1], { l: localMatch[1], d: comment || 'ローカル変数', t: 'var' });
                continue;
            }
            const funcMatch = codePart.match(/function\s+([a-zA-Z_]\w*)/);
            if (funcMatch) {
                vars.set(funcMatch[1], { l: funcMatch[1], d: comment || 'ユーザー関数', t: 'func_user' });
                continue;
            }
            const globalMatch = codePart.match(/^([a-zA-Z_]\w*)\s*=/);
            if (globalMatch) {
                const name = globalMatch[1];
                if (!["if", "while", "for", "local", "else", "elseif", "end", "return"].includes(name)) {
                    if (!vars.has(name)) {
                        vars.set(name, { l: name, d: comment || 'グローバル変数', t: 'var' });
                    }
                }
            }
        }
        userDefinedVars = Array.from(vars.values());
    }

    function updateSidebar() { if(editor) updateSidebarPosition(editor.getPosition()); }
    function updateSidebarPosition(pos) {
        if(!editor) return;
        const model = editor.getModel();
        const word = model.getWordUntilPosition(pos).word.toLowerCase();
        let allItems = [...userDefinedVars, ...apiData];
        let candidates = [];
        if (!word) candidates = allItems.slice(0, 50);
        else candidates = allItems.filter(i => i.l.toLowerCase().includes(word)).slice(0, 50);
        
        const list = document.getElementById('candidate-list');
        list.innerHTML = '';
        candidates.forEach(item => {
            const li = document.createElement('li');
            li.className = 'candidate-item';
            let c = '#ccc';
            if(item.t==='func') c='var(--func-color)';
            else if(item.t==='const') c='var(--const-color)';
            else if(item.t==='var') c='var(--var-color)';
            
            let meaningHtml = item.d ? `<span class="cand-meaning">${item.d}</span>` : '';
            li.innerHTML = `
                <div class="cand-top">
                    <div style="display:flex; align-items:center;">
                        <span class="cand-label" style="color:${c}">${item.l}</span>
                        ${meaningHtml}
                    </div>
                    <span class="cand-type">${item.t}</span>
                </div>
                <div class="cand-desc">${item.d || ''}</div>`;
            li.onclick = () => insertCode(item);
            list.appendChild(li);
        });
    }

    function getKind(t) {
        if(t==='func') return monaco.languages.CompletionItemKind.Function;
        if(t==='const') return monaco.languages.CompletionItemKind.Constant;
        if(t==='key') return monaco.languages.CompletionItemKind.Keyword;
        return monaco.languages.CompletionItemKind.Variable;
    }

    function saveFile() {
        const val = editor.getValue();
        let name = document.getElementById('filename').value || 'script.lua';
        if(!name.match(/\.(lua|txt)$/)) name += '.lua';
        const blob = new Blob([val], {type: "text/plain;charset=utf-8"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = name;
        a.click();
        showToast("保存: " + name);
    }

    // --- V16 強化版共有機能 (ChromeOS / Android / PC対応) ---
    async function shareScript() {
        const val = editor.getValue();
        let name = document.getElementById('filename').value || 'script.lua';
        if(!name.match(/\.(lua|txt)$/)) name += '.lua';

        const file = new File([val], name, { type: "text/plain" });
        const shareData = {
            title: name,
            text: 'GG Lua Script',
            files: [file]
        };

        // ChromeOSではnavigator.canShareがtrueでも共有シートが出ない場合があるが、
        // navigator.shareを呼ぶことが標準のAndroidアプリ連携手順。
        // PC版Chromeなどではエラーになるためcatchしてダウンロードに回す。
        if (navigator.share) {
            try {
                await navigator.share(shareData);
                showToast("共有しました");
            } catch (err) {
                // ユーザーキャンセル(AbortError)以外はダウンロードへ
                if (err.name !== 'AbortError') {
                    console.log("Share API failed, falling back to download.", err);
                    saveFile();
                }
            }
        } else {
            saveFile();
        }
    }

    function importFile(input) {
        const f = input.files[0]; if(!f) return;
        const r = new FileReader(); r.onload=e=>{
            const fullRange = editor.getModel().getFullModelRange();
            editor.executeEdits('import', [{ range: fullRange, text: e.target.result }]);
            document.getElementById('filename').value=f.name;
        }; 
        r.readAsText(f);
    }
</script>
</body>
</html>
