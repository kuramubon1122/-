--- START OF FILE Paste February 01, 2026 - 12:25AM ---
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GameGuardian Lua Editor V14 (Smart Parse & Share)</title>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --sidebar-bg: #252526;
            --header-bg: #2d2d2d;
            --text-color: #cccccc;
            --highlight: #0e639c;
            --border: #3e3e42;
            --btn-bg: #3c3c3c;
            --btn-hover: #505050;
            --func-color: #dcdcaa;
            --const-color: #4fc1ff;
            --keyword-color: #c586c0;
            --var-color: #9cdcfe;
        }
        * { box-sizing: border-box; outline: none; }
        body {
            margin: 0; padding: 0;
            width: 100vw; height: 100vh;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }

        #toolbar {
            background-color: var(--header-bg);
            border-bottom: 1px solid var(--border);
            padding: 4px 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
            z-index: 100;
        }
        .btn-group {
            display: flex; gap: 1px; background: #444; padding: 2px; border-radius: 4px;
        }
        button {
            background-color: var(--btn-bg); color: #eee; border: 1px solid transparent;
            padding: 5px 10px; cursor: pointer; font-size: 12px; border-radius: 2px;
            transition: all 0.1s; user-select: none;
        }
        button:hover { background-color: var(--btn-hover); }
        button:active { background-color: var(--highlight); }
        
        .search-container {
            display: flex; align-items: center; background: #333; padding: 2px 5px; border-radius: 4px; border: 1px solid #555;
        }
        #search-input {
            background: transparent; border: none; color: white; width: 140px; font-size: 12px; margin-right: 5px;
        }
        .search-badge {
            font-size: 10px; color: #aaa; margin-right: 5px; min-width: 40px; text-align: center;
        }
        
        #filename {
            background: #333; border: 1px solid #555; color: #eee; padding: 4px; font-size: 12px; width: 100px; border-radius: 3px;
        }

        #main-area { display: flex; flex: 1; height: calc(100vh - 80px); position: relative; }
        #editor-container { flex: 1; height: 100%; overflow: hidden; }

        #sidebar {
            width: 260px; background-color: var(--sidebar-bg); border-left: 1px solid var(--border);
            display: flex; flex-direction: column; z-index: 90;
        }
        #sidebar-header {
            padding: 5px; background: #222; font-size: 11px;
            border-bottom: 1px solid var(--border); color: #aaa; text-align: center;
        }
        #candidate-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        
        .candidate-item {
            padding: 6px 10px; cursor: pointer; border-bottom: 1px solid #333;
            display: flex; flex-direction: column; justify-content: center;
        }
        .candidate-item:hover { background-color: #2a2d2e; }
        .cand-top { display: flex; justify-content: space-between; align-items: center; }
        .cand-label { font-weight: bold; font-size: 12px; }
        .cand-type { font-size: 9px; padding: 1px 4px; border-radius: 3px; background: #444; color: #aaa; }
        .cand-desc { font-size: 10px; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; }

        #statusbar {
            height: 22px; background: #007acc; color: white; font-size: 11px;
            display: flex; align-items: center; padding: 0 10px; justify-content: space-between;
        }

        #toast {
            visibility: hidden; min-width: 200px; background-color: #333; color: #fff;
            text-align: center; border-radius: 4px; padding: 10px; position: fixed;
            z-index: 2000; left: 50%; bottom: 40px; transform: translateX(-50%);
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); font-size: 12px; border: 1px solid #555;
            opacity: 0; transition: opacity 0.3s, bottom 0.3s;
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }

        .search-line-highlight { background: rgba(255, 0, 0, 0.3) !important; border-left: 3px solid #ff0000; }
        .search-match-text { background-color: #ffffff !important; color: #000000 !important; font-weight: bold; }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }

        @media (max-width: 768px) {
            #sidebar { display: none; position: absolute; right: 0; top: 0; bottom: 0; width: 240px; }
            #sidebar.open { display: flex; box-shadow: -5px 0 15px rgba(0,0,0,0.5); }
        }
    </style>
</head>
<body>

<div id="toolbar">
    <div class="btn-group">
        <button onclick="execCmd('undo')">↩</button>
        <button onclick="execCmd('redo')">↪</button>
    </div>
    
    <div class="btn-group">
        <button onclick="formatCode()">整形</button>
        <button onclick="autoComment()">解説</button>
    </div>

    <div class="search-container">
        <input type="text" id="search-input" placeholder="検索..." oninput="doSearch()">
        <div class="search-badge" id="search-count">0/0</div>
        <button onclick="searchNext(true)" style="background:none; border:none; padding:0 5px;">▼</button>
    </div>

    <div class="btn-group" style="margin-left:auto;">
        <button onclick="toggleSidebar()">候補</button>
        <button onclick="shareCode()" title="コードを共有・コピー">共有</button>
        <button onclick="saveFile()">保存</button>
    </div>
</div>

<div id="main-area">
    <div id="editor-container"></div>
    <div id="sidebar">
        <div id="sidebar-header">変数・関数一覧</div>
        <ul id="candidate-list"></ul>
    </div>
</div>

<div id="statusbar">
    <span id="hint-msg">GameGuardian Lua Editor V14</span>
    <span id="cursor-pos">Ln 1, Col 1</span>
</div>

<div id="toast">Message</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.38.0/min/vs/loader.min.js"></script>

<script>
    // --- API Data ---
    const apiData = [
        {l:'gg.alert', d:'警告ダイアログ', t:'func', i:'gg.alert("${1:msg}")'},
        {l:'gg.toast', d:'通知を表示', t:'func', i:'gg.toast("${1:msg}")'},
        {l:'gg.searchNumber', d:'数値を検索', t:'func', i:'gg.searchNumber("${1:100}", ${2:gg.TYPE_DWORD})'},
        {l:'gg.editAll', d:'結果を一括書き換え', t:'func', i:'gg.editAll("${1:val}", ${2:gg.TYPE_DWORD})'},
        {l:'gg.getResults', d:'結果リストを取得', t:'func', i:'gg.getResults(${1:100})'},
        {l:'gg.clearResults', d:'検索結果を消去', t:'func', i:'gg.clearResults()'},
        {l:'gg.sleep', d:'待機 (ミリ秒)', t:'func', i:'gg.sleep(${1:1000})'},
        {l:'gg.setVisible', d:'UIの表示/非表示', t:'func', i:'gg.setVisible(${1:true})'},
        {l:'gg.prompt', d:'入力ダイアログ', t:'func', i:'gg.prompt({${1:"Msg"}}, {${2}}, {${3:"number"}})'},
        {l:'gg.choice', d:'選択リスト', t:'func', i:'gg.choice({${1:"A","B"}}, ${2:nil}, ${3:"Title"})'},
        {l:'gg.TYPE_DWORD', t:'const', d:'4バイト整数'}, {l:'gg.TYPE_FLOAT', t:'const', d:'浮動小数点'},
        {l:'print', t:'func', i:'print(${1})', d:'ログ出力'},
        {l:'local', t:'key', i:'local ', d:'ローカル変数'},
        {l:'function', t:'key', i:'function ${1:name}(${2})\n\t${3}\nend', d:'関数定義'},
        {l:'if', t:'key', i:'if ${1:cond} then\n\t${2}\nend', d:'条件分岐'},
    ];

    let editor;
    let userDefinedItems = []; // {l:name, d:definition, t:'var'|'func'}
    let isInserting = false;
    let searchMatches = [];
    let currentMatchIdx = -1;
    let currentDecorations = []; 

    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.38.0/min/vs' }});

    require(['vs/editor/editor.main'], function() {
        monaco.languages.registerCompletionItemProvider('lua', {
            provideCompletionItems: function(model, position) {
                const wordInfo = model.getWordUntilPosition(position);
                const range = {
                    startLineNumber: position.lineNumber, endLineNumber: position.lineNumber,
                    startColumn: wordInfo.startColumn, endColumn: wordInfo.endColumn
                };
                
                const suggestions = [
                    ...apiData.map(item => ({
                        label: item.l, kind: getKind(item.t), documentation: item.d,
                        insertText: item.i || item.l, insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                        range: range
                    })),
                    ...userDefinedItems.map(v => ({
                        label: v.l, kind: v.t === 'func' ? monaco.languages.CompletionItemKind.Function : monaco.languages.CompletionItemKind.Variable,
                        insertText: v.l, range: range, detail: v.d
                    }))
                ];
                return { suggestions: suggestions };
            }
        });

        editor = monaco.editor.create(document.getElementById('editor-container'), {
            value: '-- GameGuardian Script V14\nlocal targetValue = 1234 -- 検索する値\n\nfunction doSearch(val)\n    gg.searchNumber(val, gg.TYPE_DWORD)\n    gg.alert("完了: " .. val)\nend\n\ndoSearch(targetValue)',
            language: 'lua', theme: 'vs-dark', automaticLayout: true, fontSize: 14,
            minimap: { enabled: true }, wordWrap: 'on'
        });

        editor.onDidChangeModelContent(() => { parseUserVars(); updateSidebar(); });
        editor.onDidChangeCursorPosition((e) => {
            updateSidebarPosition(e.position);
            document.getElementById('cursor-pos').innerText = `Ln ${e.position.lineNumber}, Col ${e.position.column}`;
        });
        
        // 選択コピー機能
        editor.onMouseUp(() => {
            const txt = editor.getModel().getValueInRange(editor.getSelection());
            if(txt && !isInserting) {
                navigator.clipboard.writeText(txt).then(() => showToast("コピー: " + (txt.length > 10 ? txt.substring(0,10)+"..." : txt)));
            }
        });

        parseUserVars();
        updateSidebar();
        startHintCycle();
    });

    // --- 共有機能 ---
    async function shareCode() {
        const code = editor.getValue();
        if (navigator.share) {
            try {
                await navigator.share({
                    title: 'GG Lua Script',
                    text: code
                });
            } catch (err) {}
        } else {
            // Web Share非対応ブラウザ用
            navigator.clipboard.writeText(code);
            showToast("コードをクリップボードにコピーしました");
        }
    }

    // --- 変数解析機能 (意味を抽出) ---
    function parseUserVars() {
        if(!editor) return;
        const model = editor.getModel();
        const lines = model.getLinesContent();
        const items = [];
        const seen = new Set();

        lines.forEach((line, i) => {
            const trimLine = line.trim();
            // local 変数の抽出
            let m;
            const rVar = /local\s+([a-zA-Z_]\w*)/g;
            while((m = rVar.exec(trimLine))) {
                if(!seen.has(m[1])) {
                    items.push({l: m[1], d: `Line ${i+1}: ${trimLine}`, t: 'var'});
                    seen.add(m[1]);
                }
            }
            // 関数の抽出
            const rFunc = /function\s+([a-zA-Z_]\w*)/g;
            while((m = rFunc.exec(trimLine))) {
                if(!seen.has(m[1])) {
                    items.push({l: m[1], d: `Line ${i+1}: ${trimLine}`, t: 'func'});
                    seen.add(m[1]);
                }
            }
        });
        userDefinedItems = items;
    }

    function updateSidebarPosition(pos) {
        if(!editor) return;
        const word = editor.getModel().getWordUntilPosition(pos).word.toLowerCase();
        const all = [...userDefinedItems, ...apiData];
        const candidates = word ? all.filter(i => i.l.toLowerCase().includes(word)) : all.slice(0, 50);

        const list = document.getElementById('candidate-list');
        list.innerHTML = '';
        candidates.forEach(item => {
            const li = document.createElement('li');
            li.className = 'candidate-item';
            let color = '#ccc';
            if(item.t==='func') color='var(--func-color)';
            else if(item.t==='const') color='var(--const-color)';
            else if(item.t==='var') color='var(--var-color)';

            li.innerHTML = `
                <div class="cand-top">
                    <span class="cand-label" style="color:${color}">${item.l}</span>
                    <span class="cand-type">${item.t}</span>
                </div>
                <div class="cand-desc">${item.d || ''}</div>
            `;
            li.onclick = () => insertCode(item);
            list.appendChild(li);
        });
    }

    function insertCode(item) {
        isInserting = true;
        editor.focus();
        const pos = editor.getPosition();
        const wordInfo = editor.getModel().getWordUntilPosition(pos);
        const range = new monaco.Range(pos.lineNumber, wordInfo.startColumn, pos.lineNumber, wordInfo.endColumn);
        
        const insertText = item.i || item.l;
        editor.executeEdits('insert', [{ range: range, text: '', forceMoveMarkers: true }]);
        
        const snippet = editor.getContribution('snippetController2');
        if (snippet && (item.i)) {
            snippet.insert(item.i);
        } else {
            editor.trigger('keyboard', 'type', { text: insertText });
        }
        setTimeout(()=> isInserting=false, 100);
    }

    function formatCode() {
        const model = editor.getModel();
        const val = model.getValue();
        // 簡易整形 (V13ロジック準拠)
        let lines = val.split('\n').map(l => l.trim()).filter(l => l);
        let depth = 0;
        let result = [];
        lines.forEach(line => {
            if(line.match(/^(end|else|elseif|until|\})/)) depth = Math.max(0, depth - 1);
            result.push("    ".repeat(depth) + line);
            if(line.match(/(then|do|repeat|\{|\bfunction\b)$/) && !line.match(/end$/)) depth++;
        });
        editor.setValue(result.join('\n'));
        showToast("コードを整形しました");
    }

    function doSearch() {
        const q = document.getElementById('search-input').value;
        if(!q) { 
            currentDecorations = editor.deltaDecorations(currentDecorations, []);
            return;
        }
        searchMatches = editor.getModel().findMatches(q, false, false, false, null, true);
        const decs = searchMatches.map(m => ([
            { range: m.range, options: { className: 'search-match-text' } },
            { range: m.range, options: { isWholeLine: true, className: 'search-line-highlight' } }
        ])).flat();
        currentDecorations = editor.deltaDecorations(currentDecorations, decs);
        document.getElementById('search-count').innerText = `1/${searchMatches.length}`;
    }

    function searchNext(next) {
        if(!searchMatches.length) return;
        currentMatchIdx = next ? (currentMatchIdx + 1) % searchMatches.length : (currentMatchIdx - 1 + searchMatches.length) % searchMatches.length;
        editor.revealRangeInCenter(searchMatches[currentMatchIdx].range);
        document.getElementById('search-count').innerText = `${currentMatchIdx+1}/${searchMatches.length}`;
    }

    function execCmd(c) { editor.focus(); if(c==='undo') editor.trigger('k','undo'); else editor.trigger('k','redo'); }

    function autoComment() {
        const m = editor.getModel();
        const edits = [];
        const dict = {}; apiData.forEach(i=>dict[i.l]=i.d);
        for(let i=1; i<=m.getLineCount(); i++){
            const l = m.getLineContent(i);
            if(l.includes('--')) continue;
            for(let k in dict){
                if(l.includes(k)){
                    edits.push({ range: new monaco.Range(i, l.length+1, i, l.length+1), text: ` -- ${dict[k]}` });
                    break;
                }
            }
        }
        editor.executeEdits('autoComment', edits);
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.className = "show";
        setTimeout(() => t.className = "", 2000);
    }

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
    function startHintCycle() {
        const hints = ["ヒント: 共有ボタンでコードを即座に送信", "ヒント: 候補欄には変数の定義行が表示されます", "ヒント: 範囲選択で自動コピー"];
        let idx = 0;
        setInterval(() => { document.getElementById('hint-msg').innerText = hints[++idx % hints.length]; }, 5000);
    }
    function saveFile() {
        const blob = new Blob([editor.getValue()], {type: "text/plain"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "script.lua";
        a.click();
    }
    function getKind(t) {
        if(t==='func') return monaco.languages.CompletionItemKind.Function;
        if(t==='const') return monaco.languages.CompletionItemKind.Constant;
        return monaco.languages.CompletionItemKind.Keyword;
    }
    function updateSidebar() { if(editor) updateSidebarPosition(editor.getPosition()); }
</script>
</body>
</html>
