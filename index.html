<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="connect-src 'self' https://script.google.com https://script.googleusercontent.com;">
    <title>くらむぼんのホームページ</title>
    <style>
        :root {
            --primary-color: #98FB98;
            --secondary-color: #3CB371;
            --bg-color: #F0FFF0;
            --widget-bg: #fff;
            --text-color: #333;
            --radius: 12px;
            --shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        body { font-family: 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; }
        #main-content { width: 100%; max-width: 800px; }
        .widget { background-color: var(--widget-bg); padding: 25px; margin-bottom: 20px; border-radius: var(--radius); box-shadow: var(--shadow); border-left: 5px solid var(--secondary-color); }
        h1, h2 { color: var(--secondary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; margin-top: 0; }
        .top-nav { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        .nav-btn { padding: 15px; background-color: var(--secondary-color); color: white; text-decoration: none; text-align: center; font-weight: bold; border-radius: var(--radius); transition: background-color 0.3s, transform 0.2s; }
        .nav-btn:hover { background-color: #2e8b57; transform: translateY(-2px); }
        .youtube-container { display: flex; align-items: center; gap: 20px; margin-top: 25px; }
        .youtube-link img { height: 200px; border-radius: var(--radius); transition: opacity 0.3s; display: block; }
        .youtube-link:hover img { opacity: 0.85; }
        .explain { color: var(--text-color); }
        .explain h1 { font-size: 1.5em; margin-bottom: 10px; border-bottom: none; }
        .explain p { margin: 0; }
        .divider { height: 2px; background-color: #e0e0e0; width: 100%; margin: 25px 0; }
        .video-slider-wrapper { position: relative; margin-top: 20px; }
        .video-slider-container { position: relative; width: 100%; overflow: hidden; }
        .video-slider { display: flex; }
        .video-item { flex: 0 0 calc(100% / 3); box-sizing: border-box; padding: 8px; text-align: center; }
        .video-item a { text-decoration: none; color: var(--text-color); display: block; }
        .video-item img { width: 100%; border-radius: var(--radius); box-shadow: var(--shadow); transition: transform 0.3s; aspect-ratio: 16 / 9; object-fit: cover; }
        .video-item a:hover img { transform: scale(1.05); }
        .video-title { margin-top: 8px; font-size: 14px; font-weight: bold; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; height: 2.8em; }
        .slider-nav { position: absolute; top: 50%; transform: translateY(-50%); width: 40px; height: 40px; background-color: rgba(0, 0, 0, 0.5); color: white; border: none; border-radius: 50%; font-size: 24px; cursor: pointer; z-index: 10; display: flex; justify-content: center; align-items: center; transition: opacity 0.3s, background-color 0.3s; opacity: 0; pointer-events: none; }
        .video-slider-wrapper:hover .slider-nav { opacity: 1; pointer-events: auto; }
        .slider-nav:hover { background-color: rgba(0, 0, 0, 0.8); }
        #prev-btn { left: -20px; }
        #next-btn { right: -20px; }
        #loading-indicator { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 0; color: var(--text-color); gap: 10px; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: var(--secondary-color); animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 600px) { .video-item { flex: 0 0 50%; } .youtube-container { flex-direction: column; } #prev-btn { left: 5px; } #next-btn { right: 5px; } }
    </style>
</head>
<body>
    <main id="main-content">
        <section class="widget">
            <h1>くらむぼん</h1>
            <div class="top-nav">
                <a href="ログイン.html" class="nav-btn">ステータス編集</a>
                <a href="開発者について.html" class="nav-btn">開発者について</a>
                <a href="Lua_editor.html" class="nav-btn">Lua editor</a>
            </div>
            <div class="youtube-container">
                <a href="https://youtube.com/channel/UCTvT5704yfXyBjzFoWSg0CA?si=SZ7U0PjuVURPrfOl" target="_blank" class="youtube-link"><img src="チャンネルアイコン.jpg" alt="YouTubeチャンネルアイコン"></a>
                <div class="explain">
                    <p>2023年チャンネル開設。</p>
                    <div class="divider"></div>
                    <h1>ブロスタのプロフ</h1>
                    <p>総トロ74000以上。<br>最高マスター1</p>
                </div>
            </div>
            <div class="divider"></div>
            <h2 id="popular-videos-title" style="display: none;">人気の動画</h2>
            <div id="loading-indicator">
                <div class="spinner"></div>
                <p>動画を読み込み中...</p>
            </div>
            <div id="slider-root" style="display: none;">
                <div class="video-slider-wrapper">
                    <div class="video-slider-container"><div class="video-slider"></div></div>
                    <button id="prev-btn" class="slider-nav">&lt;</button>
                    <button id="next-btn" class="slider-nav">&gt;</button>
                </div>
            </div>
        </section>
        <section class="widget">
            <h1>文章暗号化BOT</h1>
            <div class="youtube-container">
                <a href="https://line.me/R/ti/p/@630pniaf" target="_blank" class="youtube-link"><img src="暗号化BOTアイコン.jpg" alt="暗号化BOTアイコン"></a>
                <div class="explain">
                    <p>LINEで使える暗号化BOT</p>
                    <div class="divider"></div>
                    <h1>詳細</h1>
                    <p>1: で送信した文字を暗号化するモードに変更します。<br>2: で送信した文字を復号化するモードに変更します。<br>3:"ここに鍵を入力" で送信した文字を鍵とし暗号化、復号化します。</p>
                </div>
            </div>
        </section>
    </main>

    <!-- ▼▼▼ ここからJavaScriptの修正箇所 ▼▼▼ -->
    <script>
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxy6KEmjZxwgLDygZ-Eom3qbsaE0k5iZ3XBLRN0tRHzdN-KVk7kecZVhPSzQofssrTd/exec';
        const CACHE_KEY = 'youtube_video_cache'; // sessionStorageに保存する際のキー

        const sliderRoot = document.getElementById('slider-root');
        const slider = document.querySelector('.video-slider');
        const popularVideosTitle = document.getElementById('popular-videos-title');
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');
        const loadingIndicator = document.getElementById('loading-indicator');

        let videos = [];
        let currentIndex = 0;
        let itemWidth = 0;
        let visibleItems = 3;
        let autoScrollInterval;
        let isTransitioning = false;

        function moveSlider(index, withAnimation = true) { /* (変更なし) */ if(isTransitioning&&withAnimation)return;if(withAnimation){isTransitioning=true;slider.style.transition='transform 0.5s ease-in-out';}else{slider.style.transition='none';} slider.style.transform=`translateX(-${index*itemWidth}px)`;currentIndex=index; }
        function nextSlide() { /* (変更なし) */ if(isTransitioning)return;moveSlider(currentIndex+1); }
        function prevSlide() { /* (変更なし) */ if(isTransitioning)return;moveSlider(currentIndex-1); }
        function startAutoScroll() { /* (変更なし) */ stopAutoScroll();autoScrollInterval=setInterval(nextSlide,3500); }
        function stopAutoScroll() { /* (変更なし) */ clearInterval(autoScrollInterval); }
        function resetAutoScroll() { /* (変更なし) */ stopAutoScroll();startAutoScroll(); }

        function setupSlider(videoData) {
            // setupSliderは引数で動画データを受け取るように変更
            videos = videoData;

            if (videos.length === 0) {
                loadingIndicator.innerHTML = '<p>表示する動画がありません。</p>';
                return;
            }

            loadingIndicator.style.display = 'none';
            popularVideosTitle.style.display = 'block';
            sliderRoot.style.display = 'block';
            visibleItems = window.innerWidth <= 600 ? 2 : 3;
            const clonesEnd = videos.slice(0, visibleItems);
            const clonesStart = videos.slice(-visibleItems);
            const allItems = [...clonesStart, ...videos, ...clonesEnd];
            slider.innerHTML = allItems.map(video => `<div class="video-item"><a href="${video.url}" target="_blank" rel="noopener noreferrer"><img src="${video.thumbnail}" alt="${video.title}" loading="lazy"><p class="video-title">${video.title}</p></a></div>`).join('');
            itemWidth = slider.querySelector('.video-item').getBoundingClientRect().width;
            moveSlider(visibleItems, false);
            slider.addEventListener('transitionend', () => { isTransitioning=false;if(currentIndex>=videos.length+visibleItems){moveSlider(visibleItems,false);} if(currentIndex<=visibleItems-1){moveSlider(videos.length+visibleItems-1,false);} });
            nextBtn.addEventListener('click', () => { nextSlide(); resetAutoScroll(); });
            prevBtn.addEventListener('click', () => { prevSlide(); resetAutoScroll(); });
            sliderRoot.addEventListener('mouseenter', stopAutoScroll);
            sliderRoot.addEventListener('mouseleave', startAutoScroll);
            if (videos.length > visibleItems) { startAutoScroll(); } else { nextBtn.style.display = 'none'; prevBtn.style.display = 'none'; }
        }

        /**
         * 動画情報を取得するメイン関数 (キャッシュ機能付き)
         */
        async function fetchVideos() {
            // 1. sessionStorageからキャッシュされたデータを試みる
            const cachedData = sessionStorage.getItem(CACHE_KEY);

            if (cachedData) {
                console.log('キャッシュから動画データを読み込みました。');
                const videoData = JSON.parse(cachedData);
                setupSlider(videoData); // キャッシュされたデータでスライダーを即時表示
                return; // GASへの通信は行わない
            }

            // 2. キャッシュがない場合のみ、GASにデータをリクエスト
            console.log('キャッシュが見つからないため、GASから動画データを取得します。');
            try {
                const response = await fetch(GAS_WEB_APP_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const videoData = await response.json();
                
                // 取得したデータをsessionStorageに保存
                sessionStorage.setItem(CACHE_KEY, JSON.stringify(videoData));
                console.log('動画データをキャッシュに保存しました。');
                
                setupSlider(videoData); // 取得したデータでスライダーを表示
            } catch (error) {
                console.error('動画の読み込みエラー:', error);
                loadingIndicator.innerHTML = '<p>動画の読み込みに失敗しました。時間をおいて再読み込みしてください。</p>';
            }
        }

        document.addEventListener('DOMContentLoaded', fetchVideos);

        window.addEventListener('resize', () => {
            stopAutoScroll();
            if (videos.length > 0) {
                // ウィンドウサイズ変更時もキャッシュされたデータを使って再描画
                setupSlider(videos);
            }
        });
    </script>
    <!-- ▲▲▲ JavaScriptの修正箇所ここまで ▲▲▲ -->
</body>
</html>