<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- CSPè¨­å®š -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data:; style-src 'self' 'unsafe-inline' https:; script-src 'self' 'unsafe-inline' https:; img-src 'self' https: data:; connect-src 'self' https:;">

    <title>ãƒ–ãƒ­ã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¤œç´¢ | åå‰æ¤œç´¢ãƒ»çµ±è¨ˆãƒ»åˆ†æãƒ»ã‚¢ã‚¤ã‚³ãƒ³ç¢ºèª</title>
    <style>
        body { background-color: #121212; color: #fff; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; padding: 20px; margin: 0; }
        
        h1 { 
            color: #ffc107; 
            margin-bottom: 5px; 
            text-transform: uppercase;
            text-shadow: 0 0 10px rgba(255,193,7,0.7), 0 0 20px rgba(255,193,7,0.5);
            animation: glow 2s infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 0 0 10px rgba(255,193,7,0.7), 0 0 20px rgba(255,193,7,0.5); }
            to { text-shadow: 0 0 20px rgba(255, 235, 59, 1), 0 0 30px rgba(255, 193, 7, 0.8); }
        }

        .subtitle { color: #888; font-size: 0.9rem; margin-bottom: 30px; font-weight: bold; }
        
        .record-count { 
            color: #29b6f6; 
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.5em; 
            font-weight: bold;
            display: inline-block;
            min-width: 150px;
        }

        .search-container { max-width: 600px; margin: 0 auto; background: #1e1e1e; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        
        .radio-group { display: flex; justify-content: center; gap: 15px; margin-bottom: 15px; }
        .radio-group label { cursor: pointer; color: #aaa; font-size: 0.9rem; transition: 0.2s; }
        .radio-group label:hover { color: #fff; }
        .radio-group input:checked + span { color: #ffc107; font-weight: bold; text-decoration: underline; }
        
        .search-box { display: flex; gap: 10px; }
        input[type="text"] { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #333; font-size: 16px; background: #2c2c2c; color: #fff; outline: none; transition: 0.3s; }
        input[type="text"]:focus { border-color: #ffc107; background: #333; }
        
        button { padding: 12px 25px; border-radius: 8px; border: none; background: #ffc107; color: #000; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:hover { background: #ffca28; transform: scale(1.05); }
        
        table { width: 100%; max-width: 800px; margin: 30px auto; border-collapse: collapse; background: #1e1e1e; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #333; vertical-align: middle; }
        th { background: #252525; color: #aaa; font-size: 0.85em; letter-spacing: 1px; }
        tr:hover { background: #2a2a2a; }
        
        .profile-icon { 
            width: 44px; height: 44px; 
            border-radius: 6px; 
            object-fit: cover; 
            background: #000; 
            border: 2px solid #555;
            transition: transform 0.2s;
            opacity: 0.6; /* ãƒ­ãƒ¼ãƒ‰å‰ã¯å°‘ã—æš—ã */
        }
        .profile-icon.loaded {
            opacity: 1;
            border-color: #ffc107;
        }

        .icon-cell { width: 60px; text-align: center; }

        a.detail-link { 
            display: inline-block;
            color: #fff; background: #29b6f6; padding: 6px 12px; 
            text-decoration: none; border-radius: 4px; font-size: 0.85em; font-weight: bold;
            transition: background 0.2s, transform 0.1s;
        }
        a.detail-link:hover { background: #0288d1; transform: translateY(-2px); }
        
        .tag { font-family: monospace; color: #ffc107; font-weight: bold; }
        #loading { display: none; margin-top: 20px; color: #888; font-style: italic; }
        .error { color: #ff5252; margin-top: 20px; font-weight: bold; }
        .status-msg { font-size: 0.8rem; color: #666; margin-top: 5px; min-height: 1.2em; }

        .seo-footer {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px solid #333;
            color: #444;
            font-size: 0.75rem;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <h1>âš¡ BRAWL ULTIMATE DB</h1>
    <p class="subtitle">DATABASE RECORDS: <span id="db-count" class="record-count">0</span></p>

    <div class="search-container">
        <div class="radio-group">
            <label><input type="radio" name="mode" value="tag"><span>ğŸ†” IDæ¤œç´¢</span></label>
            <label><input type="radio" name="mode" value="exact"><span>ğŸ¯ åå‰(å®Œå…¨)</span></label>
            <label><input type="radio" name="mode" value="partial" checked><span>ğŸ” åå‰(éƒ¨åˆ†)</span></label>
        </div>
        <div class="search-box">
            <input type="text" id="q" placeholder="æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›...">
            <button onclick="search()">æ¤œç´¢</button>
        </div>
        <div id="status-msg" class="status-msg"></div>
    </div>

    <div id="loading">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç…§ä¼šä¸­...</div>
    <p id="error" class="error"></p>

    <table id="result-table" style="display:none;">
        <thead>
            <tr>
                <th>ICON</th>
                <th>TAG (A-Z)</th>
                <th>NAME</th>
                <th>INFO</th>
            </tr>
        </thead>
        <tbody id="list"></tbody>
    </table>

    <div class="seo-footer">
        <p>BRAWL ULTIMATE DB - Player Statistics & Analysis Tool</p>
    </div>

<script>
    const API_BASE = "https://katodeth-brawl-database-v2.hf.space";
    const TOTAL_RECORDS = 30525403; 
    const iconCache = new Map();
    let isFetchingIcons = false; // ã‚¢ã‚¤ã‚³ãƒ³å–å¾—é‡è¤‡é˜²æ­¢ãƒ•ãƒ©ã‚°

    window.onload = function() {
        animateCounter("db-count", 0, TOTAL_RECORDS, 800);
    };

    function animateCounter(id, start, end, duration) {
        const obj = document.getElementById(id);
        const range = end - start;
        let startTime = null;
        function step(timestamp) {
            if (!startTime) startTime = timestamp;
            const progress = timestamp - startTime;
            const percent = Math.min(progress / duration, 1);
            const ease = percent * (2 - percent);
            const current = Math.floor(start + (range * ease));
            obj.innerHTML = current.toLocaleString();
            if (progress < duration) {
                window.requestAnimationFrame(step);
            } else {
                obj.innerHTML = end.toLocaleString();
            }
        }
        window.requestAnimationFrame(step);
    }

    async function search() {
        const q = document.getElementById('q').value.trim();
        if (!q) return;

        // å‰å›ã®ã‚¢ã‚¤ã‚³ãƒ³å–å¾—å‡¦ç†ãŒã‚ã‚Œã°ä¸­æ–­ã—ãŸã„ãŒã€ç°¡å˜ã®ãŸã‚ãƒ•ãƒ©ã‚°ç®¡ç†
        isFetchingIcons = false; 

        const mode = document.querySelector('input[name="mode"]:checked').value;
        const loading = document.getElementById('loading');
        const resultTable = document.getElementById('result-table');
        const errorMsg = document.getElementById('error');
        const list = document.getElementById('list');
        const statusMsg = document.getElementById('status-msg');

        loading.style.display = 'block';
        resultTable.style.display = 'none';
        errorMsg.innerText = '';
        list.innerHTML = '';
        statusMsg.innerText = '';

        try {
            const res = await fetch(`${API_BASE}/api/search?q=${encodeURIComponent(q)}&mode=${mode}`);
            if (!res.ok) throw new Error(`Server Error: ${res.status}`);
            
            let data = await res.json();

            if (data.length === 0) {
                errorMsg.innerText = "è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
            } else {
                // â˜…ä¿®æ­£: ã‚¿ã‚°(ID)ã®è¾æ›¸é †(ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †)ã«ã‚½ãƒ¼ãƒˆ
                data.sort((a, b) => a.tag.localeCompare(b.tag));

                // ãƒªã‚¹ãƒˆæç”»
                data.forEach(p => {
                    const cleanTag = p.tag.replace('#', '');
                    const detailLink = `https://brawlinsights.com/ja/player/profile/${cleanTag}`;
                    const defaultIcon = "https://cdn.brawlify.com/profile-icons/regular/28000000.png";

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="icon-cell">
                            <img src="${defaultIcon}" 
                                 id="icon-${cleanTag}" 
                                 class="profile-icon" 
                                 alt="Icon">
                        </td>
                        <td class="tag">#${cleanTag}</td>
                        <td>${p.name}</td>
                        <td><a href="${detailLink}" target="_blank" class="detail-link">è©³ç´°ãƒ»åˆ†æ â†—</a></td>
                    `;
                    list.appendChild(tr);
                });
                resultTable.style.display = 'table';
                
                // â˜…ä¿®æ­£: ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã€Œ1ã¤ãšã¤é †ç•ªã«ã€å–å¾—ã™ã‚‹é–¢æ•°ã‚’å‘¼ã³å‡ºã™
                // ã“ã‚Œã«ã‚ˆã‚Šä¸€æ–‰ã‚¢ã‚¯ã‚»ã‚¹ã«ã‚ˆã‚‹CORS/429ã‚¨ãƒ©ãƒ¼ã‚’é˜²ã
                fetchIconsSequentially(data);
            }
        } catch (e) {
            console.error(e);
            errorMsg.innerHTML = "é€šä¿¡ã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒãƒ¼å¿œç­”ãªã—ã€ã¾ãŸã¯æ··é›‘ã—ã¦ã„ã¾ã™ã€‚";
        } finally {
            loading.style.display = 'none';
        }
    }

    // â˜…æ–°æ©Ÿèƒ½: ã‚¢ã‚¤ã‚³ãƒ³ã‚’é †ç•ªã«å–å¾—ã™ã‚‹å‡¦ç†
    async function fetchIconsSequentially(players) {
        isFetchingIcons = true;
        const statusMsg = document.getElementById('status-msg');
        
        for (let i = 0; i < players.length; i++) {
            if (!isFetchingIcons) break; // æ–°ã—ã„æ¤œç´¢ãŒå§‹ã¾ã£ãŸã‚‰ä¸­æ–­

            const p = players[i];
            const cleanTag = p.tag.replace('#', '');
            
            // çŠ¶æ³è¡¨ç¤ºï¼ˆä»»æ„ï¼‰
            // statusMsg.innerText = `ã‚¢ã‚¤ã‚³ãƒ³èª­ã¿è¾¼ã¿ä¸­... ${i + 1}/${players.length}`;

            await updatePlayerIcon(cleanTag);
            
            // ã‚µãƒ¼ãƒãƒ¼è² è·è»½æ¸›ã®ãŸã‚ã€æ¬¡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¾ã§å°‘ã—å¾…ã¤ (500ms)
            await new Promise(resolve => setTimeout(resolve, 500));
        }
        statusMsg.innerText = "";
    }

    // â˜…ä¿®æ­£: ã‚¢ã‚¤ã‚³ãƒ³å–å¾— (alloriginsã® /get ãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ç”¨)
    // /get ã¯JSONã§ãƒ©ãƒƒãƒ—ã•ã‚ŒãŸå¿œç­”ã‚’è¿”ã™ãŸã‚ã€HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¦ã‚‚CORSé•åã«ãªã‚Šã«ãã„
    async function updatePlayerIcon(tag) {
        const imgEl = document.getElementById(`icon-${tag}`);
        if (!imgEl) return;

        if (iconCache.has(tag)) {
            const cachedId = iconCache.get(tag);
            imgEl.src = `https://cdn.brawlify.com/profile-icons/regular/${cachedId}.png`;
            imgEl.classList.add('loaded');
            return;
        }

        try {
            // BrawlAPIã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
            // # ã‚’ %23 ã«ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¦æ¸¡ã™å¿…è¦ãŒã‚ã‚‹
            const brawlApiUrl = `https://api.brawlapi.com/v1/players/%23${tag}`;
            
            // allorigins.win/get ã‚’ä½¿ç”¨ã€‚ã“ã‚Œã¯ { "contents": "..." } ã¨ã„ã†JSONã‚’è¿”ã™ã€‚
            // ãƒ–ãƒ©ã‚¦ã‚¶å´ã§ã¯å¸¸ã«æ­£å¸¸ãªJSONå–å¾—ã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹ãŸã‚ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®èµ¤ã‚¨ãƒ©ãƒ¼ãŒæ¶ˆãˆã‚‹ã€‚
            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(brawlApiUrl)}`;

            const res = await fetch(proxyUrl);
            if (res.ok) {
                const wrapper = await res.json();
                // wrapper.contents ã«å®Ÿéš›ã®APIãƒ¬ã‚¹ãƒãƒ³ã‚¹(æ–‡å­—åˆ—)ãŒå…¥ã£ã¦ã„ã‚‹
                if (wrapper.contents) {
                    try {
                        const apiData = JSON.parse(wrapper.contents);
                        if (apiData.icon && apiData.icon.id) {
                            const iconId = apiData.icon.id;
                            iconCache.set(tag, iconId);
                            imgEl.src = `https://cdn.brawlify.com/profile-icons/regular/${iconId}.png`;
                            imgEl.classList.add('loaded');
                        }
                    } catch (parseError) {
                        // JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦– (404ãƒšãƒ¼ã‚¸HTMLãªã©ãŒè¿”ã£ã¦ããŸå ´åˆãªã©)
                    }
                }
            }
        } catch (e) {
            // é€šä¿¡ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
        }
    }

    document.getElementById('q').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') search();
    });
</script>
</body>
</html>
