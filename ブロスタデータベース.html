<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ–ãƒ­ã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</title>
    <style>
        :root { --primary: #ffc107; --bg: #121212; --card: #1e1e1e; --text: #fff; --accent: #29b6f6; }
        body { background-color: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; padding: 20px; text-align: center; }
        h1 { color: var(--primary); text-shadow: 0 0 15px var(--primary); }
        .search-container { max-width: 700px; margin: 0 auto; background: var(--card); padding: 30px; border-radius: 20px; }
        input { padding: 15px; width: 60%; border-radius: 10px; border: none; }
        button { padding: 15px 30px; border-radius: 10px; border: none; background: var(--primary); font-weight: bold; cursor: pointer; }
        table { width: 100%; max-width: 800px; margin: 20px auto; border-collapse: collapse; background: var(--card); }
        th, td { padding: 15px; border-bottom: 1px solid #333; text-align: left; }
        th { color: #aaa; }
        .player-icon { width: 40px; height: 40px; border-radius: 8px; vertical-align: middle; margin-right: 10px; }
        .trophy-cell { color: #ffca28; font-weight: bold; text-align: right; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; }
        .modal { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 600px; background: #151515; padding: 20px; border-radius: 15px; max-height: 90vh; overflow-y: auto; }
        .close-btn { float: right; background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer; }
        a { color: var(--accent); text-decoration: none; }
    </style>
</head>
<body>
    <h1>âš¡ BRAWL ULTIMATE DB</h1>
    <p>Total Database: <span id="count">0</span> Players</p>
    
    <div class="search-container">
        <input type="text" id="q" placeholder="åå‰ ã¾ãŸã¯ ã‚¿ã‚°(#...)">
        <button onclick="search()">æ¤œç´¢</button>
        <div style="margin-top:10px; font-size:0.9rem; color:#888;">
            <label><input type="radio" name="mode" value="partial" checked> éƒ¨åˆ†ä¸€è‡´</label>
            <label><input type="radio" name="mode" value="exact"> å®Œå…¨ä¸€è‡´</label>
            <label><input type="radio" name="mode" value="tag"> IDæ¤œç´¢</label>
        </div>
        <div style="margin-top:10px;">
             <button onclick="setSort('trophies')" style="padding:5px 10px; font-size:0.8rem; background:#333; color:#ccc;">ğŸ† ãƒˆãƒ­ãƒ•ã‚£ãƒ¼é †</button>
             <button onclick="setSort('tag')" style="padding:5px 10px; font-size:0.8rem; background:#333; color:#ccc;">ğŸ†” IDé †</button>
        </div>
    </div>

    <button onclick="showAll()" style="margin-top:20px; background:transparent; border:1px solid var(--primary); color:var(--primary);">ğŸ“š å…¨å“¡è¡¨ç¤º</button>

    <div id="loading" style="display:none; margin-top:20px;">â³ èª­ã¿è¾¼ã¿ä¸­...</div>
    <div id="error" style="color:red; margin-top:10px;"></div>

    <table id="result-table" style="display:none;">
        <thead><tr><th>PLAYER</th><th>TAG</th><th>TROPHIES</th></tr></thead>
        <tbody id="list"></tbody>
    </table>

    <div id="pagination" style="display:none; margin:20px;">
        <button onclick="changePage(-1)">â®</button>
        <span id="page-num" style="margin:0 10px;">1</span>
        <button onclick="changePage(1)">â¯</button>
    </div>

    <div style="margin-top:50px;">
        <h3>ğŸ‡¯ğŸ‡µ æ—¥æœ¬ãƒˆãƒƒãƒ—ãƒ©ãƒ³ã‚«ãƒ¼ (Live)</h3>
        <table id="ranking-table"><tbody id="ranking-list"><tr><td>Loading...</td></tr></tbody></table>
    </div>

    <div class="modal-overlay" id="modal" onclick="document.getElementById('modal').style.display='none'">
        <div class="modal" onclick="event.stopPropagation()">
            <button class="close-btn" onclick="document.getElementById('modal').style.display='none'">Ã—</button>
            <div id="modal-content"></div>
        </div>
    </div>

    <script>
        const DB_API = "https://katodeth-brawl-database-v4.hf.space";
        const GCP_API = "https://afternoon-oliver-together-fare.trycloudflare.com";
        let currentSort = 'trophies';
        let currentPage = 1;
        let currentQuery = "";
        let isShowAll = false;

        // ã‚¹ãƒ­ãƒƒãƒˆæ¼”å‡º
        const countEl = document.getElementById('count');
        fetch(`${DB_API}/api/stats`).then(r=>r.json()).then(d=>{
            let start = 0; const end = d.count;
            const step = (ts) => {
                if (!start) start = ts;
                const progress = Math.min((ts - start) / 1000, 1); // 1ç§’
                countEl.innerText = Math.floor(end * progress).toLocaleString();
                if (progress < 1) requestAnimationFrame(step);
            };
            requestAnimationFrame(step);
        }).catch(()=>countEl.innerText="---");

        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°
        fetch(`${GCP_API}/rankings/jp?limit=10`).then(r=>r.json()).then(d=>{
            const l = document.getElementById('ranking-list'); l.innerHTML='';
            d.items.forEach((p,i)=>{
                l.innerHTML += `<tr onclick="showDetails('${p.tag.replace('#','')}')">
                    <td>${i+1}. <img src="https://cdn.brawlify.com/profile-icons/regular/${p.icon.id}.png" class="player-icon">${p.name}</td>
                    <td class="trophy-cell">ğŸ† ${p.trophies.toLocaleString()}</td></tr>`;
            });
        }).catch(()=>document.getElementById('ranking-list').innerHTML='<tr><td>ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—å¤±æ•—</td></tr>');

        function setSort(s) { currentSort=s; if(isShowAll) showAll(1); else if(currentQuery) search(1); }
        function showAll(p=1) { isShowAll=true; currentQuery=""; currentPage=p; fetchData("", p); }
        function search(p=1) { isShowAll=false; const q=document.getElementById('q').value.trim(); if(q){ currentQuery=q; currentPage=p; fetchData(q, p); }}
        function changePage(d) { fetchData(currentQuery, currentPage + d); }

        async function fetchData(q, p) {
            currentPage = p;
            const mode = document.querySelector('input[name="mode"]:checked').value;
            document.getElementById('loading').style.display='block';
            document.getElementById('result-table').style.display='none';
            document.getElementById('list').innerHTML='';
            document.getElementById('error').innerText='';

            try {
                let url = `${DB_API}/api/search?q=${encodeURIComponent(q)}&mode=${mode}&sort=${currentSort}`;
                if(!q) url += `&page=${p}`;
                
                const res = await fetch(url);
                const data = await res.json();
                
                if(data.length===0) {
                    document.getElementById('error').innerText = "ãªã—";
                } else {
                    data.forEach(x => {
                        const imgId = `img-${x.tag}`;
                        const trpId = `trp-${x.tag}`;
                        // ä»®è¡¨ç¤º
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td><img src="https://cdn.brawlify.com/profile-icons/regular/28000001.png" id="${imgId}" class="player-icon">${x.name}</td>
                                         <td style="font-family:monospace">#${x.tag}</td>
                                         <td class="trophy-cell" id="${trpId}">ğŸ† ${x.trophies.toLocaleString()}</td>`;
                        tr.onclick = () => showDetails(x.tag);
                        document.getElementById('list').appendChild(tr);
                        
                        // GCPã§æœ€æ–°åŒ–
                        fetch(`${GCP_API}/player/${x.tag}`).then(r=>r.json()).then(d=>{
                            if(d.icon && d.icon.id) document.getElementById(imgId).src=`https://cdn.brawlify.com/profile-icons/regular/${d.icon.id}.png`;
                            if(d.trophies) document.getElementById(trpId).innerText=`ğŸ† ${d.trophies.toLocaleString()}`;
                        });
                    });
                    document.getElementById('result-table').style.display='table';
                    if(!q) {
                        document.getElementById('pagination').style.display='flex';
                        document.getElementById('page-num').innerText=p;
                        document.getElementById('prev-btn').disabled=(p===1);
                        document.getElementById('next-btn').disabled=(data.length<30);
                    } else {
                         document.getElementById('pagination').style.display='none';
                    }
                }
            } catch(e) { document.getElementById('error').innerText="é€šä¿¡ã‚¨ãƒ©ãƒ¼"; }
            document.getElementById('loading').style.display='none';
        }

        async function showDetails(tag) {
            document.getElementById('modal').style.display='block';
            document.getElementById('modal-content').innerHTML='Loading...';
            try {
                const [p, log] = await Promise.all([
                    fetch(`${GCP_API}/player/${tag}`).then(r=>r.json()),
                    fetch(`${GCP_API}/battlelog/${tag}`).then(r=>r.ok?r.json():{items:[]})
                ]);
                if(p.error) throw new Error();
                
                let bHtml = p.brawlers.sort((a,b)=>b.trophies-a.trophies).map(b=>`
                    <div style="display:inline-block;text-align:center;margin:5px;font-size:0.8em;">
                        <img src="https://cdn.brawlify.com/brawler-pins/${b.id}.png" style="width:40px;"><br>ğŸ†${b.trophies}
                    </div>`).join('');
                
                let lHtml = log.items.slice(0,5).map(i=>`
                    <div style="border-left:4px solid ${i.battle.result==='victory'?'green':'red'};background:#222;padding:5px;margin:5px 0;">
                        ${i.event.mode} (${i.battle.result||'?'})
                    </div>`).join('');

                document.getElementById('modal-content').innerHTML = `
                    <div style="text-align:center">
                        <img src="https://cdn.brawlify.com/profile-icons/regular/${p.icon.id}.png" style="width:80px;border-radius:10px;">
                        <h2>${p.name} <span style="font-size:0.6em;color:#aaa">#${p.tag}</span></h2>
                        <p>ğŸ† ${p.trophies.toLocaleString()} (æœ€é«˜: ${p.highestTrophies})</p>
                        <p>3v3: ${p['3vs3Victories']} | Solo: ${p.soloVictories} | Duo: ${p.duoVictories}</p>
                    </div>
                    <hr>
                    <h4>ç›´è¿‘ãƒãƒˆãƒ«</h4>${lHtml}
                    <hr>
                    <h4>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼</h4>${bHtml}
                `;
            } catch(e) { document.getElementById('modal-content').innerHTML='å–å¾—å¤±æ•—'; }
        }
        
        document.getElementById('q').addEventListener('keypress', e => { if(e.key==='Enter') search() });
    </script>
</body>
</html>
