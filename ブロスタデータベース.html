<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- CSPè¨­å®š: ç”»åƒã‚„æ¥ç¶šå…ˆã‚’è¨±å¯ -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data:; style-src 'self' 'unsafe-inline' https:; script-src 'self' 'unsafe-inline' https:; img-src 'self' https: data:; connect-src 'self' https:;">

    <title>ãƒ–ãƒ­ã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¤œç´¢ | åå‰æ¤œç´¢ãƒ»çµ±è¨ˆãƒ»åˆ†æãƒ»ã‚¢ã‚¤ã‚³ãƒ³ç¢ºèª</title>
    <meta name="description" content="BRAWL ULTIMATE DBã¯ã€ãƒ–ãƒ­ã‚¹ã‚¿(Brawl Stars)ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åå‰æ¤œç´¢ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç…§ä¼šã€çµ±è¨ˆåˆ†æã‚’è¡Œã†ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚">

    <style>
        body { background-color: #121212; color: #fff; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; padding: 20px; margin: 0; }
        
        h1 { 
            color: #ffc107; 
            margin-bottom: 5px; 
            text-transform: uppercase;
            text-shadow: 0 0 10px rgba(255,193,7,0.7), 0 0 20px rgba(255,193,7,0.5);
            animation: glow 2s infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 0 0 10px rgba(255,193,7,0.7), 0 0 20px rgba(255,193,7,0.5); }
            to { text-shadow: 0 0 20px rgba(255, 235, 59, 1), 0 0 30px rgba(255, 193, 7, 0.8); }
        }

        .subtitle { color: #888; font-size: 0.9rem; margin-bottom: 30px; font-weight: bold; }
        
        .record-count { 
            color: #29b6f6; 
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.5em; 
            font-weight: bold;
            display: inline-block;
            min-width: 150px;
        }

        .search-container { max-width: 600px; margin: 0 auto; background: #1e1e1e; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        
        .radio-group { display: flex; justify-content: center; gap: 15px; margin-bottom: 15px; }
        .radio-group label { cursor: pointer; color: #aaa; font-size: 0.9rem; transition: 0.2s; }
        .radio-group label:hover { color: #fff; }
        .radio-group input:checked + span { color: #ffc107; font-weight: bold; text-decoration: underline; }
        
        .search-box { display: flex; gap: 10px; }
        input[type="text"] { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #333; font-size: 16px; background: #2c2c2c; color: #fff; outline: none; transition: 0.3s; }
        input[type="text"]:focus { border-color: #ffc107; background: #333; }
        
        button { padding: 12px 25px; border-radius: 8px; border: none; background: #ffc107; color: #000; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:hover { background: #ffca28; transform: scale(1.05); }
        
        table { width: 100%; max-width: 800px; margin: 30px auto; border-collapse: collapse; background: #1e1e1e; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #333; vertical-align: middle; }
        th { background: #252525; color: #aaa; font-size: 0.85em; letter-spacing: 1px; }
        tr:hover { background: #2a2a2a; }
        
        .profile-icon { 
            width: 44px; height: 44px; 
            border-radius: 6px; 
            object-fit: cover; 
            background: #000; 
            border: 2px solid #555;
            transition: transform 0.2s;
        }
        .profile-icon:hover { transform: scale(1.1); border-color: #ffc107; }
        .icon-cell { width: 60px; text-align: center; }

        a.detail-link { 
            display: inline-block;
            color: #fff; background: #29b6f6; padding: 6px 12px; 
            text-decoration: none; border-radius: 4px; font-size: 0.85em; font-weight: bold;
            transition: background 0.2s, transform 0.1s;
        }
        a.detail-link:hover { background: #0288d1; transform: translateY(-2px); }
        
        .tag { font-family: monospace; color: #ffc107; font-weight: bold; }
        #loading { display: none; margin-top: 20px; color: #888; font-style: italic; }
        .error { color: #ff5252; margin-top: 20px; font-weight: bold; }

        .seo-footer {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px solid #333;
            color: #444;
            font-size: 0.75rem;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <h1>âš¡ BRAWL ULTIMATE DB</h1>
    <p class="subtitle">DATABASE RECORDS: <span id="db-count" class="record-count">0</span></p>

    <div class="search-container">
        <div class="radio-group">
            <label><input type="radio" name="mode" value="tag"><span>ğŸ†” IDæ¤œç´¢</span></label>
            <label><input type="radio" name="mode" value="exact"><span>ğŸ¯ åå‰(å®Œå…¨)</span></label>
            <label><input type="radio" name="mode" value="partial" checked><span>ğŸ” åå‰(éƒ¨åˆ†)</span></label>
        </div>
        <div class="search-box">
            <input type="text" id="q" placeholder="æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›...">
            <button onclick="search()">æ¤œç´¢</button>
        </div>
    </div>

    <div id="loading">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç…§ä¼šä¸­...</div>
    <p id="error" class="error"></p>

    <table id="result-table" style="display:none;">
        <thead>
            <tr>
                <th>ICON</th>
                <th>TAG (A-Z)</th>
                <th>NAME</th>
                <th>INFO</th>
            </tr>
        </thead>
        <tbody id="list"></tbody>
    </table>

    <div class="seo-footer">
        <p>
            BRAWL ULTIMATE DBã¸ã‚ˆã†ã“ãã€‚ã“ã“ã¯ä¸–ç•Œæœ€å¤§ç´šã®<strong>ãƒ–ãƒ­ã‚¹ã‚¿(Brawl Stars)</strong>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã™ã€‚
            ãƒ—ãƒ­ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åˆ†æã‚„ãƒ•ãƒ¬ãƒ³ãƒ‰ã®æˆ¦ç¸¾ç¢ºèªã«æœ€é©åŒ–ã•ã‚Œã¦ãŠã‚Šã€IDæ¤œç´¢ã‚„éƒ¨åˆ†ä¸€è‡´æ¤œç´¢ã‚‚ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚
        </p>
    </div>

<script>
    const API_BASE = "https://katodeth-brawl-database-v2.hf.space";
    const TOTAL_RECORDS = 30525403; 
    const iconCache = new Map();

    window.onload = function() {
        animateCounter("db-count", 0, TOTAL_RECORDS, 800);
    };

    function animateCounter(id, start, end, duration) {
        const obj = document.getElementById(id);
        const range = end - start;
        let startTime = null;
        function step(timestamp) {
            if (!startTime) startTime = timestamp;
            const progress = timestamp - startTime;
            const percent = Math.min(progress / duration, 1);
            const ease = percent * (2 - percent);
            const current = Math.floor(start + (range * ease));
            obj.innerHTML = current.toLocaleString();
            if (progress < duration) {
                window.requestAnimationFrame(step);
            } else {
                obj.innerHTML = end.toLocaleString();
            }
        }
        window.requestAnimationFrame(step);
    }

    async function search() {
        const q = document.getElementById('q').value.trim();
        if (!q) return;

        const mode = document.querySelector('input[name="mode"]:checked').value;
        const loading = document.getElementById('loading');
        const resultTable = document.getElementById('result-table');
        const errorMsg = document.getElementById('error');
        const list = document.getElementById('list');

        loading.style.display = 'block';
        resultTable.style.display = 'none';
        errorMsg.innerText = '';
        list.innerHTML = '';

        try {
            const res = await fetch(`${API_BASE}/api/search?q=${encodeURIComponent(q)}&mode=${mode}`);
            
            if (!res.ok) throw new Error(`Server Error: ${res.status}`);
            
            let data = await res.json();

            if (data.length === 0) {
                errorMsg.innerText = "è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
            } else {
                // â˜…ä¿®æ­£1: ã‚¿ã‚°(ID)ã®ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ã«ã‚½ãƒ¼ãƒˆï¼ˆè¾æ›¸é †ï¼‰
                data.sort((a, b) => {
                    return a.tag.localeCompare(b.tag);
                });

                data.forEach(p => {
                    const cleanTag = p.tag.replace('#', '');
                    const detailLink = `https://brawlinsights.com/ja/player/profile/${cleanTag}`;
                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¤ã‚³ãƒ³ï¼ˆåˆæœŸçŠ¶æ…‹ï¼‰
                    const defaultIcon = "https://cdn.brawlify.com/profile-icons/regular/28000000.png";

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="icon-cell">
                            <img src="${defaultIcon}" 
                                 id="icon-${cleanTag}" 
                                 class="profile-icon" 
                                 alt="Icon">
                        </td>
                        <td class="tag">#${cleanTag}</td>
                        <td>${p.name}</td>
                        <td><a href="${detailLink}" target="_blank" class="detail-link">è©³ç´°ãƒ»åˆ†æ â†—</a></td>
                    `;
                    list.appendChild(tr);

                    // é…å»¶èª­ã¿è¾¼ã¿ã§ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°
                    updatePlayerIcon(cleanTag);
                });
                resultTable.style.display = 'table';
            }
        } catch (e) {
            console.error(e);
            errorMsg.innerHTML = "é€šä¿¡ã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒãƒ¼å¿œç­”ãªã—ã€ã¾ãŸã¯æ··é›‘ã—ã¦ã„ã¾ã™ã€‚<br>æ™‚é–“ã‚’ãŠã„ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚";
        } finally {
            loading.style.display = 'none';
        }
    }

    // â˜…ä¿®æ­£2: ã‚¢ã‚¤ã‚³ãƒ³å–å¾—é–¢æ•°ã®å¤§å¹…è¦‹ç›´ã—
    async function updatePlayerIcon(tag) {
        const imgEl = document.getElementById(`icon-${tag}`);
        if (!imgEl) return;

        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ã‚ã‚Œã°ãã‚Œã‚’ä½¿ã†
        if (iconCache.has(tag)) {
            const cachedId = iconCache.get(tag);
            imgEl.src = `https://cdn.brawlify.com/profile-icons/regular/${cachedId}.png`;
            return;
        }

        try {
            // BrawlAPIã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
            const targetUrl = `https://api.brawlapi.com/v1/players/%23${tag}`;
            
            // alloriginsã®ä»£ã‚ã‚Šã« 'corsproxy.io' ã‚’ä½¿ç”¨ï¼ˆã‚ˆã‚Šå˜ç´”ãªãƒ—ãƒ­ã‚­ã‚·ï¼‰
            // ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¯ãƒ­ã‚¹ã‚ªãƒªã‚¸ãƒ³(CORS)ã‚¨ãƒ©ãƒ¼ã‚’å›é¿ã—ã¤ã¤ç”Ÿã®JSONã‚’å–å¾—å¯èƒ½
            const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`;

            const res = await fetch(proxyUrl);
            
            if (res.ok) {
                // corsproxyã¯ä¸­èº«ã‚’ãã®ã¾ã¾è¿”ã™ã®ã§ã€ç›´æ¥JSONã¨ã—ã¦ãƒ‘ãƒ¼ã‚¹å¯èƒ½
                const apiData = await res.json();
                
                // ã‚¢ã‚¤ã‚³ãƒ³IDãŒå­˜åœ¨ã™ã‚Œã°æ›´æ–°
                if (apiData.icon && apiData.icon.id) {
                    const iconId = apiData.icon.id;
                    iconCache.set(tag, iconId);
                    imgEl.src = `https://cdn.brawlify.com/profile-icons/regular/${iconId}.png`;
                }
            }
        } catch (e) {
            // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã¯å‡ºã•ãšã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã®ã¾ã¾ã«ã™ã‚‹
            // console.warn(`Icon fetch failed for ${tag}:`, e); 
        }
    }

    document.getElementById('q').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') search();
    });
</script>
</body>
</html>
